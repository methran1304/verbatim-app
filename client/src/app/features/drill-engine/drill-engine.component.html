<div class="drill-engine-center" (click)="focusInput()">
  <app-drill-toolbar
    [wpm]="wpm"
    [accuracy]="accuracy"
    [remainingSeconds]="remainingSeconds"
    [currentWordIndex]="currentWordIndex"
    [totalWords]="sourceText.length"
    [drillPreference]="drillPreferences"
    [isTyping]="isTyping"
    [disabled]="showPostDrillOverlay"
    [forceCollapsed]="showPostDrillOverlay"
    [showAdaptiveDrillOverlay]="showAdaptiveDrillOverlay"
    [currentDrillType]="drillPreferences.drillType"
    (restart)="onRestart()"
    (newDrill)="onNewDrill()"
    (viewErrorWords)="onViewErrorWords()"
    (drillPreferenceChange)="onDrillPreferenceChange($event)"
  ></app-drill-toolbar>

  <app-drill-text
    [sourceText]="sourceText"
    [typedInput]="typedText"
    [currentWordIndex]="currentWordIndex"
    [currentCharIndex]="currentCharIndex"
    [isFocused]="isInputFocused"
    [showPostDrillOverlay]="showPostDrillOverlay"
    [showAdaptiveDrillOverlay]="showAdaptiveDrillOverlay"
    [isSubmitting]="isSubmitting"
    [submitError]="submitError"
    [isUserInactive]="isUserInactive"
    [hasBeenInactive]="hasBeenInactive"
    [afkReason]="afkReason"
    [isGeneratingAdaptive]="isGeneratingAdaptive"
    [isLoadingErrorWords]="isLoadingErrorWords"
    (postDrillRestart)="onRestart()"
    (postDrillSubmit)="onPostDrillSubmit()"
    (generateAdaptiveDrill)="onGenerateAdaptiveDrill()"
    (viewErrorProneWords)="onViewErrorProneWords()"
  ></app-drill-text>

  <app-virtual-keyboard
    [inputValue]="currentInput"
    [isDarkTheme]="isDarkMode"
  ></app-virtual-keyboard>

  @if (isDrillActive) {
  <app-drill-input (keyTyped)="onKeyTyped($event)" (focusEvent)="onInputFocus()"
    (blurEvent)="onInputBlur()"></app-drill-input>
  }
</div>

<!-- Error Words Modal -->
<nz-modal
  [(nzVisible)]="showErrorWordsModal"
  nzTitle="Recent Misspelled"
  (nzOnCancel)="onCloseErrorWordsModal()"
  [nzFooter]="null"
  [nzWidth]="600">
  <ng-container *nzModalContent>
    <div class="error-words-content">
      <p>Here are the words you recently misspelled that will be used used to generate the adaptive drill:</p>
      <div class="error-words-list">
        @for (word of getErrorWords(); track word) {
          <nz-tag class="error-word-tag">{{ word }}</nz-tag>
        }
      </div>
      @if (getErrorWords().length === 0) {
        <p class="no-error-words">No recent misspelled words found. The drill will be generated using general difficulty patterns.</p>
      }
    </div>
  </ng-container>
</nz-modal>