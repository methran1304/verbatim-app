<div class="drill-page drill-engine-center" (click)="focusInput()">
  <!-- normal drill toolbar (hidden in competitive mode when in lobby) -->
  @if (!isCompetitive || !roomState.showRoomModeOverlay) {
    <app-drill-toolbar
      [wpm]="wpm"
      [accuracy]="accuracy"
      [remainingSeconds]="timerState?.remainingSeconds || 0"
      [currentWordIndex]="currentWordIndex"
      [totalWords]="sourceText.length"
      [drillPreference]="drillPreferences"
      [isTyping]="isTyping"
      [disabled]="showPostDrillOverlay"
      [forceCollapsed]="showPostDrillOverlay || roomState.showRoomOverlay || showAdaptiveDrillOverlay"
      [showAdaptiveDrillOverlay]="showAdaptiveDrillOverlay"
      [currentDrillType]="drillPreferences.drillType"
      (restart)="onRestart()"
      (newDrill)="onNewDrill()"
      (viewErrorWords)="onViewErrorWords()"
      (drillPreferenceChange)="onDrillPreferenceChange($event)"
      (changePreference)="onChangePreference()"
    ></app-drill-toolbar>
  }

  <!-- room settings toolbar (shown in competitive mode when in lobby) -->
  @if (isCompetitive && roomState.showRoomModeOverlay) {
    <app-room-settings-toolbar
      [drillType]="roomState.drillType || 'Timed'"
      [difficulty]="roomState.difficulty || 'Intermediate'"
      [duration]="roomState.duration || '60s'">
    </app-room-settings-toolbar>
  }

  <app-drill-text
    [sourceText]="sourceText"
    [typedInput]="typedText"
    [currentWordIndex]="currentWordIndex"
    [currentCharIndex]="currentCharIndex"
    [isFocused]="isInputFocused"
    [showPostDrillOverlay]="showPostDrillOverlay"
    [showAdaptiveDrillOverlay]="showAdaptiveDrillOverlay"
    [isSubmitting]="isSubmitting"
    [submitError]="submitError"
    [isUserInactive]="isUserInactive"
    [hasBeenInactive]="hasBeenInactive"
    [afkReason]="afkReason"
    [isGeneratingAdaptive]="isGeneratingAdaptive"
    [isLoadingErrorWords]="isLoadingErrorWords"
    [showRoomOverlay]="roomState.showRoomOverlay"
    [showLobbyOverlay]="roomState.showRoomModeOverlay"
    [roomCode]="roomState.roomCode"
    [userRole]="roomState.userRole"
    [roomState]="roomState.roomState"
    [drillType]="roomState.drillType || 'Timed'"
    [difficulty]="roomState.difficulty || 'Intermediate'"
    [duration]="roomState.duration || '60s'"
    [currentDifficulty]="drillPreferences.drillDifficulty"
    [currentLength]="drillPreferences.drillLength"
    [isCurrentUserReady]="isCurrentUserReady"
    [players]="players"
    (postDrillRestart)="onRestart()"
    (postDrillSubmit)="onPostDrillSubmit()"
    (generateAdaptiveDrill)="onGenerateAdaptiveDrill($event)"
    (viewErrorProneWords)="onViewErrorProneWords($event)"
    (leaveRoom)="onLeaveRoom()"
    (startDrill)="onStartCompetitiveDrill()"
    (setReady)="onSetReady()"
  ></app-drill-text>

  
  <!-- Show player panel in competitive mode when in lobby, otherwise show virtual keyboard -->
  @if (showPlayerPanel) {
    <app-player-panel
      [players]="players"
      [currentUserId]="currentUserId"
      [isCreator]="roomState.userRole === 'Creator'"
      [isActiveDrill]="false"
      [show]="showPlayerPanel"
      (kickPlayer)="onKickPlayer($event)">
    </app-player-panel>
  } @else {
    <app-virtual-keyboard [inputValue]="currentInput" [isDarkTheme]="isDarkMode">
    </app-virtual-keyboard>
  }
  

  @if (isDrillActive) {
  <app-drill-input (keyTyped)="onKeyTyped($event)" (focusEvent)="onInputFocus()"
    (blurEvent)="onInputBlur()"></app-drill-input>
  }
</div>

<!-- Adaptive Drill Modal -->
<app-adaptive-drill-modal
  [isVisible]="showErrorWordsModal"
  [errorProneWords]="errorProneWords"
  [isLoading]="isLoadingErrorWords"
  (closeModal)="onCloseErrorWordsModal()">
</app-adaptive-drill-modal>