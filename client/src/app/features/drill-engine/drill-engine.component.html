<div class="drill-page drill-engine-center" (click)="focusInput()">
  <!-- normal drill toolbar (hidden in competitive mode when in lobby) -->
  @if (!isCompetitive || !roomState.showRoomModeOverlay) {
    <app-drill-toolbar
      [wpm]="wpm"
      [accuracy]="accuracy"
      [remainingSeconds]="timerState?.remainingSeconds || 0"
      [currentWordIndex]="currentWordIndex"
      [totalWords]="sourceText.length"
      [drillPreference]="drillPreferences"
      [isTyping]="isTyping"
      [disabled]="showPostDrillOverlay || isCompetitive"
      [forceCollapsed]="showPostDrillOverlay || roomState.showRoomOverlay || showAdaptiveDrillOverlay || isCompetitive"
      [showAdaptiveDrillOverlay]="showAdaptiveDrillOverlay"
      [currentDrillType]="drillPreferences.drillType"
      [isCompetitive]="isCompetitive"
      [isClassicsMode]="isClassicsMode"
      [bookTitle]="currentBookTitle"
      [bookAuthor]="currentBookAuthor"
      [hasProgressBeenSaved]="hasProgressBeenSaved"
      (restart)="onRestart()"
      (newDrill)="onNewDrill()"
      (viewErrorWords)="onViewErrorWords()"
      (drillPreferenceChange)="onDrillPreferenceChange($event)"
      (changePreference)="onChangePreference()"
      (saveProgress)="onSaveClassicsProgress()"
      (backToMenu)="onBackToClassicsMenu()"
    ></app-drill-toolbar>
  }

  <!-- room settings toolbar (shown in competitive mode when in lobby) -->
  @if (isCompetitive && roomState.showRoomModeOverlay) {
    <app-room-settings-toolbar
      [drillType]="roomState.drillType || 'Timed'"
      [difficulty]="roomState.difficulty || 'Intermediate'"
      [duration]="roomState.duration || '60s'">
    </app-room-settings-toolbar>
  }

  <app-drill-text
    [class.competitive-mode]="showPlayerPanel"
    [sourceText]="sourceText"
    [typedInput]="typedText"
    [currentWordIndex]="currentWordIndex"
    [currentCharIndex]="currentCharIndex"
    [isFocused]="isInputFocused"
    [showPostDrillOverlay]="showPostDrillOverlay"
    [showAdaptiveDrillOverlay]="showAdaptiveDrillOverlay"
    [isSubmitting]="isSubmitting"
    [submitError]="submitError"
    [isUserInactive]="isUserInactive"
    [hasBeenInactive]="hasBeenInactive"
    [afkReason]="afkReason"
    [isGeneratingAdaptive]="isGeneratingAdaptive"
    [isLoadingErrorWords]="isLoadingErrorWords"
    [showRoomOverlay]="roomState.showRoomOverlay"
    [showLobbyOverlay]="roomState.showRoomModeOverlay"
    [showCompetitivePostDrillOverlay]="showCompetitivePostDrillOverlay"
    [roomCode]="roomState.roomCode"
    [userRole]="roomState.userRole"
    [roomState]="roomState.roomState"
    [drillType]="roomState.drillType || 'Timed'"
    [difficulty]="roomState.difficulty || 'Intermediate'"
    [duration]="roomState.duration || '60s'"
    [currentDifficulty]="drillPreferences.drillDifficulty"
    [currentLength]="drillPreferences.drillLength"
    [isCurrentUserReady]="isCurrentUserReady"
    [players]="players"
    [winnerMessage]="winnerMessage"
    (postDrillRestart)="onRestart()"
    (postDrillSubmit)="onPostDrillSubmit()"
    (generateAdaptiveDrill)="onGenerateAdaptiveDrill($event)"
    (viewErrorProneWords)="onViewErrorProneWords($event)"
    (leaveRoom)="onLeaveRoom()"
    (startDrill)="onStartCompetitiveDrill()"
    (setReady)="onSetReady()"
  ></app-drill-text>

  
  <!-- show player panel only when user is in a room (any room state) -->
  @if (showPlayerPanel) {
    <app-player-panel
      [players]="players"
      [currentUserId]="currentUserId"
      [isCreator]="roomState.userRole === 'Creator'"
      [isActiveDrill]="roomState.roomState === 'InProgress' || showCompetitivePostDrillResults"
      [show]="true"
      [roomCode]="roomState.roomCode"
      [drillType]="roomState.drillType || 'Timed'"
      [difficulty]="roomState.difficulty || 'Intermediate'"
      [durationOrLength]="roomState.duration || ''"
      [wordsCompleted]="playerWordsCompleted"
      (kickPlayer)="onKickPlayer($event)">
    </app-player-panel>
  } @else {
    <app-virtual-keyboard 
      [inputValue]="currentInput" 
      [isDarkTheme]="isDarkMode"
      [shouldBlur]="showPostDrillOverlay || showAdaptiveDrillOverlay || roomState.showRoomOverlay">
    </app-virtual-keyboard>
  }
  

  @if (isDrillActive) {
  <app-drill-input (keyTyped)="onKeyTyped($event)" (focusEvent)="onInputFocus()"
    (blurEvent)="onInputBlur()"></app-drill-input>
  }
</div>

<!-- countdown overlay -->
<app-countdown-overlay
  [show]="showCountdown"
  [countdown]="countdownValue"
  [isBegin]="isCountdownBegin">
</app-countdown-overlay>

<!-- adaptive drill modal -->
<app-adaptive-drill-modal
  [isVisible]="showErrorWordsModal"
  [errorProneWords]="errorProneWords"
  [isLoading]="isLoadingErrorWords"
  (closeModal)="onCloseErrorWordsModal()">
</app-adaptive-drill-modal>

<!-- competitive post-drill overlay -->
<app-competitive-post-drill-overlay
  [show]="showCompetitivePostDrillOverlay"
  [winnerUsername]="competitiveWinnerUsername"
  [userWpm]="currentUserCompetitiveResults.wpm"
  [userAccuracy]="currentUserCompetitiveResults.accuracy"
  [userPointsChange]="currentUserCompetitiveResults.pointsChange"
  [isSubmitting]="isSubmitting"
  [submitError]="submitError"
  [roomCode]="roomState.roomCode"
  (continue)="onCompetitivePostDrillContinue()"
  (leaveRoom)="onCompetitivePostDrillLeaveRoom()"
  (allPlayersContinued)="showCompetitivePostDrillOverlay = false">
</app-competitive-post-drill-overlay>