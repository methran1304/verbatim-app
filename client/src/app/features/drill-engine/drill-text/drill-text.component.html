<app-afk-overlay [show]="!showPostDrillOverlay && delayedAfkOverlay"></app-afk-overlay>

<app-adaptive-drill-overlay 
  [show]="showAdaptiveDrillOverlay"
  [isLoadingErrorWords]="isLoadingErrorWords"
  [isGeneratingAdaptive]="isGeneratingAdaptive"
  [currentDifficulty]="currentDifficulty"
  [currentLength]="currentLength"
  (viewErrorProneWords)="viewErrorProneWords.emit($event)"
  (generateAdaptiveDrill)="generateAdaptiveDrill.emit($event)">
</app-adaptive-drill-overlay>

<app-room-overlay 
  [show]="showRoomOverlay"
  [isCreatingRoom]="isCreatingRoom"
  [isJoiningRoom]="isJoiningRoom"
  (createRoom)="createRoom.emit()"
  (joinRoom)="joinRoom.emit()"
  (joinRoomWithCode)="joinRoomWithCode.emit($event)"
  (goBack)="goBack.emit()">
</app-room-overlay>

  <app-lobby-overlay
    [show]="showLobbyOverlay"
    [roomCode]="roomCode"
    [userRole]="userRole"
    [roomState]="roomState"
    [drillType]="drillType"
    [difficulty]="difficulty"
    [duration]="duration"
    [isCurrentUserReady]="isCurrentUserReady"
    [players]="players"
    (leaveRoom)="leaveRoom.emit()"
    (startDrill)="startDrill.emit()"
    (setReady)="setReady.emit()">
  </app-lobby-overlay>

<app-post-drill-overlay 
  [show]="showPostDrillOverlay"
  [isSubmitting]="isSubmitting"
  [submitError]="submitError"
  [hasBeenInactive]="hasBeenInactive"
  [afkReason]="afkReason"
  (postDrillRestart)="postDrillRestart.emit()"
  (postDrillSubmit)="postDrillSubmit.emit()">
</app-post-drill-overlay>

<div class="drill-text-wrapper"
     [ngClass]="{'blur-background' : !isFocused || showPostDrillOverlay || showAdaptiveDrillOverlay || showRoomOverlay || showLobbyOverlay || showCompetitivePostDrillOverlay, 'afk-cursor': delayedAfkOverlay && !showPostDrillOverlay}">
  <nz-card class="drill-text" #drillText>
    @if (winnerMessage) {
      <div class="winner-banner">{{ winnerMessage }}</div>
    }
    <div class="drill-text-inner">
      @for (word of sourceText; track wi; let wi = $index) {
        @if (word[0] === '↵') {
          <!-- line break - show ↵ character and force new line -->
          <nz-tag class="word" [ngClass]="getWordClass(wi)" #wordEl>
            <span class="line-break-char">↵</span>
          </nz-tag>
          <!-- force line break -->
          <div class="force-line-break"></div>
        } @else {
          <nz-tag class="word" [ngClass]="getWordClass(wi)" #wordEl>
            @for (char of word; track ci; let ci = $index) {
              <span
                [ngClass]="
                  getLetterClass(wi, ci) +
                  (char === ' ' && getLetterClass(wi, ci) === 'letter-active'
                    ? ' letter-active-space'
                    : '')
                "
              >
                {{ char === " " ? "␣" : char }}
              </span>
            }
          </nz-tag>
        }
      }
    </div>
  </nz-card>

  <div class="fade-top"></div>
  <div class="fade-bottom"></div>
</div>