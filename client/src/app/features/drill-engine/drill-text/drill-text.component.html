@if (!showPostDrillOverlay && delayedAfkOverlay) {
  <nz-card id="afk-overlay" #afkoverlay>
    <p>Click here to start typing</p>
  </nz-card>
}

@if (showAdaptiveDrillOverlay) {
  <nz-card id="adaptive-overlay" #adaptiveoverlay>
    <div class="adaptive-content">
      <h2>Adaptive Drill</h2>
      <p>Adaptive drills help you practice words you commonly misspell. Choose your difficulty level and drill length to get personalized practice words tailored to your typing patterns.</p>
      <div class="post-drill-btn-row">
        <span class="post-drill-btn" (click)="viewErrorProneWords.emit()" [class.disabled]="isLoadingErrorWords || isGeneratingAdaptive">
          @if (isLoadingErrorWords) {
            <span nz-icon nzType="loading" nzTheme="outline" style="font-size: 16px;"></span>
            <span class="button-text">Loading</span>
          } @else {
            <span nz-icon nzType="eye" nzTheme="outline" style="font-size: 16px;"></span>
            <span class="button-text">Recent Misspelled</span>
          }
        </span>
        <span class="post-drill-btn" (click)="generateAdaptiveDrill.emit()" [class.disabled]="isGeneratingAdaptive || isLoadingErrorWords">
          @if (isGeneratingAdaptive) {
            <span nz-icon nzType="loading" nzTheme="outline" style="font-size: 16px;"></span>
            <span class="button-text">Generating</span>
          } @else {
            <span nz-icon nzType="robot" nzTheme="outline" style="font-size: 16px;"></span>
            <span class="button-text">Generate</span>
          }
        </span>
      </div>
      

    </div>
  </nz-card>
}

@if (showPostDrillOverlay) {
  <nz-card id="post-drill-overlay" #postdrilloverlay>
    <div class="post-drill-btn-row">
      <span class="post-drill-btn" 
            (click)="postDrillRestart.emit()"
            nz-tooltip
            nzTooltipTitle="Start the drill again with the same text and settings. Perfect for practicing the same passage multiple times."
            [nzTooltipMouseEnterDelay]="1.5">
        <span nz-icon nzType="reload" nzTheme="outline" style="font-size: 16px;"></span>
        <span class="button-text">Start Over</span>
      </span>
      <nz-divider nzType="vertical"></nz-divider>
      <span class="post-drill-btn" 
            (click)="!hasBeenInactive && postDrillSubmit.emit()"
            [class.disabled]="isSubmitting || hasBeenInactive"
            [class.error]="submitError || hasBeenInactive"
            nz-tooltip
            [nzTooltipTitle]="hasBeenInactive ? afkReason : 'Submit your drill results and save your performance data. View detailed statistics and track your progress.'"
            [nzTooltipMouseEnterDelay]="1.5">
        @if (isSubmitting) {
          <span nz-icon nzType="loading" nzTheme="outline" style="font-size: 16px;"></span>
          <span class="button-text">Submitting...</span>
        } @else if (submitError) {
          <span nz-icon nzType="exclamation-circle" nzTheme="outline" style="font-size: 16px;"></span>
          <span class="button-text">Retry</span>
        } @else if (hasBeenInactive) {
          <span nz-icon nzType="stop" nzTheme="outline" style="font-size: 16px;"></span>
          <span class="button-text">AFK Detected</span>
        } @else {
          <span nz-icon nzType="check-circle" nzTheme="outline" style="font-size: 16px;"></span>
          <span class="button-text">Submit</span>
        }
      </span>
    </div>
    
    @if (submitError) {
      <div class="error-message">
        <span nz-icon nzType="exclamation-circle" nzTheme="outline"></span>
        <span>{{ submitError }}</span>
      </div>
    }
  </nz-card>
}

<div class="drill-text-wrapper"
     [ngClass]="{'blur-background' : !isFocused || showPostDrillOverlay || showAdaptiveDrillOverlay, 'afk-cursor': delayedAfkOverlay && !showPostDrillOverlay}">
  <nz-card class="drill-text" #drillText>
    <div class="drill-text-inner">
      @for (word of sourceText; track wi; let wi = $index) {
        <nz-tag class="word" [ngClass]="getWordClass(wi)" #wordEl>
          @for (char of word; track ci; let ci = $index) {
            <span
              [ngClass]="
                getLetterClass(wi, ci) +
                (char === ' ' && getLetterClass(wi, ci) === 'letter-active'
                  ? ' letter-active-space'
                  : '')
              "
            >
              {{ char === " " ? "‚ê£" : char }}
            </span>
          }
        </nz-tag>
      }
    </div>
  </nz-card>

  <div class="fade-top"></div>
  <div class="fade-bottom"></div>
</div>