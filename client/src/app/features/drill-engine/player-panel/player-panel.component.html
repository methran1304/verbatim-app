@if (show) {
  <div class="player-panel">
    <nz-card class="player-panel-card">
      <div class="player-panel-header">
        <h3 class="panel-title">
          <span nz-icon nzType="team" nzTheme="outline"></span>
          Room #{{ roomCode }}
        </h3>
        <div class="header-right">
          <span class="settings-pill">{{ drillType }} • {{ difficulty }} • {{ durationOrLength }}</span>
          <span class="player-count">{{ players.length }}/4</span>
        </div>
      </div>

      <div class="player-list">
        @if (players.length === 0) {
          <div class="empty-state">
            <span nz-icon nzType="user-add" nzTheme="outline"></span>
            <p>No players yet</p>
            <span class="empty-hint">Share the room code to invite players</span>
          </div>
        } @else {
          <div class="player-grid-container">
            @for (player of getGridPlayers(); track player?.userId || $index) {
              <div class="player-grid-item" [class.placeholder]="!player">
                @if (player) {
                  <!-- grid Position Number -->
                  <div class="grid-position">{{ $index + 1 }}</div>
                  
                  <!-- YOU Badge at top -->
                  <div class="top-badges">
                    @if (player.userId === currentUserId) {
                      <span class="current-user-badge">YOU</span>
                    }
                    <!-- ready status badge (hidden in active drill) -->
                    @if (!isActiveDrill) {
                      <span class="ready-status-badge" [class.ready]="isPlayerReady(player)" [class.not-ready]="!isPlayerReady(player)">
                        {{ isPlayerReady(player) ? 'READY' : 'NOT READY' }}
                      </span>
                    }
                    <!-- afk badge (shown in active drill) -->
                    @if (isActiveDrill && player.isAFK) {
                      <span class="afk-badge">AFK</span>
                    }
                  </div>

                  <!-- left side: avatar, username, level (vertically aligned) -->
                  <div class="left-section">
                    <div class="avatar-container">
                      <nz-avatar 
                        [nzText]="getPlayerAvatarText(player)"
                        [nzSize]="36"
                        class="player-avatar"
                        [attr.data-color]="getPlayerAvatarColor(player)">
                      </nz-avatar>
                      @if (isActiveDrill && isPlayerFirst(player)) {
                        <span nz-icon nzType="crown" nzTheme="fill" class="winner-crown"></span>
                      }
                      @if (player.isCreator) {
                        <span nz-icon nzType="setting" nzTheme="outline" class="creator-badge"></span>
                      }
                    </div>
                    <div class="username">{{ player.username }}</div>
                    <div class="competitive-rank" [class]="getCompetitiveRankClass(player.competitiveRank)">
                      {{ player.competitiveRank || 'Bronze' }}
                    </div>
                  </div>

                  <!-- statistics section -->
                  @if (!isActiveDrill) {
                    <div class="competitive-stats">
                      <div class="metric-row stats-row">
                        <nz-statistic 
                          nzTitle="Total Drills" 
                          [nzValue]="player.competitiveStats?.totalDrills || 0" 
                          [nzValueStyle]="{ color: 'var(--color-text)' }"
                          class="player-statistic">
                        </nz-statistic>
                        <nz-statistic 
                          nzTitle="Win Rate" 
                          [nzValue]="player.competitiveStats?.winrate || 0" 
                          nzSuffix="%" 
                          [nzValueStyle]="{ color: 'var(--color-success)' }"
                          class="player-statistic">
                        </nz-statistic>
                        <nz-statistic 
                          nzTitle="Record" 
                          [nzValue]="(player.competitiveStats?.wins || 0) + ' / ' + (player.competitiveStats?.losses || 0)" 
                          [nzValueStyle]="{ color: 'var(--color-primary)' }"
                          class="player-statistic">
                        </nz-statistic>
                      </div>
                    </div>
                  } @else {
                    <!-- active drill progress -->
                    <div class="active-drill-stats">
                      @if (player.progress !== undefined) {
                        <!-- performance metrics -->
                        <div class="performance-metrics">
                          <div class="metric-row stats-row">
                            <nz-statistic 
                              nzTitle="Position" 
                              [nzValue]="getPlayerPosition(player)" 
                              [nzValueStyle]="{ color: 'var(--color-text)' }"
                              class="player-statistic">
                            </nz-statistic>
                            <nz-statistic 
                              nzTitle="WPM" 
                              [nzValue]="player.wpm || 0" 
                              [nzValueStyle]="{ color: 'var(--color-primary)' }"
                              class="player-statistic">
                            </nz-statistic>
                            <nz-statistic 
                              nzTitle="Accuracy" 
                              [nzValue]="player.accuracy || 0" 
                              nzSuffix="%" 
                              [nzValueStyle]="{ color: 'var(--color-success)' }"
                              class="player-statistic">
                            </nz-statistic>
                          </div>
                          <div class="metric-row empty-row">
                            <!-- empty space for progress bar -->
                          </div>
                        </div>
                        
                        <!-- progress bar -->
                        <div class="progress-section">
                          <nz-progress 
                            [nzPercent]="getPlayerProgress(player)" 
                            [nzSize]="'small'"
                            [nzShowInfo]="false"
                            [nzStrokeWidth]="4"
                            [nzStrokeColor]="getPlayerProgress(player) === 100 ? '#52c41a' : '#1890ff'">
                          </nz-progress>
                          <span class="progress-label">{{ getProgressLabel(player) }}</span>
                        </div>
                      }
                    </div>
                  }

                  <!-- kick badge (bottom right) -->
                  @if (isCreator && player.userId !== currentUserId) {
                    <div class="kick-badge-container">
                      <span 
                        class="kick-badge"
                        nz-popconfirm
                        nzPopconfirmTitle="Kick this player?"
                        nzOkText="Yes"
                        nzCancelText="No"
                        (nzOnConfirm)="onKickPlayer(player.userId)">
                        <span nz-icon nzType="stop" nzTheme="outline"></span>
                        KICK
                      </span>
                    </div>
                  }
                } @else {
                  <div class="placeholder-content">
                    <span nz-icon nzType="user-add" nzTheme="outline" class="placeholder-icon"></span>
                    <span class="placeholder-text">
                      @if (!isActiveDrill) {
                        Waiting for player...
                      } @else {
                        Empty slot
                      }
                    </span>
                  </div>
                }
              </div>
            }
          </div>
        }
      </div>
    </nz-card>
  </div>
}


