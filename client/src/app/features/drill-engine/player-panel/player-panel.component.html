@if (show) {
  <div class="player-panel">
    <nz-card class="player-panel-card">
      <div class="player-panel-header">
        <h3 class="panel-title">
          <span nz-icon nzType="team" nzTheme="outline"></span>
          Room #{{ roomCode }}
        </h3>
        <div class="header-right">
          <span class="settings-pill">{{ drillType }} • {{ difficulty }} • {{ durationOrLength }}</span>
          <span class="player-count">{{ players.length }}/4</span>
        </div>
      </div>

      <div class="player-list">
        @if (players.length === 0) {
          <div class="empty-state">
            <span nz-icon nzType="user-add" nzTheme="outline"></span>
            <p>No players yet</p>
            <span class="empty-hint">Share the room code to invite players</span>
          </div>
        } @else {
          <div class="player-grid-container">
            @for (player of getGridPlayers(); track player?.userId || $index) {
              <div class="player-grid-item" [class.placeholder]="!player">
                @if (player) {
                  <!-- Grid Position Number -->
                  <div class="grid-position">{{ $index + 1 }}</div>
                  
                  <!-- Crown/YOU Badge at top -->
                  <div class="top-badges">
                    @if (player.isCreator) {
                      <span nz-icon nzType="crown" nzTheme="fill" class="creator-badge"></span>
                    }
                    @if (player.userId === currentUserId) {
                      <span class="current-user-badge">YOU</span>
                    }
                    <!-- Ready Status Badge -->
                    <span class="ready-status-badge" [class.ready]="isPlayerReady(player)" [class.not-ready]="!isPlayerReady(player)">
                      {{ isPlayerReady(player) ? 'READY' : 'NOT READY' }}
                    </span>
                  </div>

                  <!-- Left side: Avatar, Username, Level (vertically aligned) -->
                  <div class="left-section">
                    <nz-avatar 
                      [nzText]="getPlayerAvatarText(player)"
                      [nzSize]="36"
                      class="player-avatar"
                      [attr.data-color]="getPlayerAvatarColor(player)">
                    </nz-avatar>
                    <div class="username">{{ player.username }}</div>
                    <div class="level">Lvl. {{ player.level }}</div>
                  </div>

                  <!-- Statistics Section -->
                  @if (!isActiveDrill) {
                    <div class="competitive-stats">
                      <div class="stats-row">
                        <div class="stat-item">Total: ({{ player.competitiveStats?.totalDrills || 0 }})</div>
                        <div class="stat-item">Winrate: {{ player.competitiveStats?.winrate || 0 }}%</div>
                      </div>
                      <div class="stats-row">
                        <div class="stat-item">Wins: ({{ player.competitiveStats?.wins || 0 }})</div>
                        <div class="stat-item">Losses: ({{ player.competitiveStats?.losses || 0 }})</div>
                      </div>
                    </div>
                  } @else {
                    <!-- Active Drill Progress -->
                    <div class="active-drill-stats">
                      @if (player.progress !== undefined) {
                        <div class="progress-section">
                          <nz-progress 
                            [nzPercent]="getPlayerProgress(player)" 
                            [nzSize]="'small'"
                            [nzShowInfo]="false"
                            [nzStrokeWidth]="4"
                            [nzStrokeColor]="getPlayerProgress(player) === 100 ? '#52c41a' : '#1890ff'">
                          </nz-progress>
                          <span class="progress-label">{{ getProgressLabel(player) }}</span>
                        </div>
                      }
                      @if (player.isAFK) {
                        <span class="afk-badge">AFK</span>
                      }
                    </div>
                  }

                  <!-- Kick Badge (bottom right) -->
                  @if (isCreator && player.userId !== currentUserId) {
                    <div class="kick-badge-container">
                      <span 
                        class="kick-badge"
                        nz-popconfirm
                        nzPopconfirmTitle="Kick this player?"
                        nzOkText="Yes"
                        nzCancelText="No"
                        (nzOnConfirm)="onKickPlayer(player.userId)">
                        <span nz-icon nzType="stop" nzTheme="outline"></span>
                        KICK
                      </span>
                    </div>
                  }
                } @else {
                  <div class="placeholder-content">
                    <span nz-icon nzType="user-add" nzTheme="outline" class="placeholder-icon"></span>
                    <span class="placeholder-text">Waiting for player...</span>
                  </div>
                }
              </div>
            }
          </div>
        }
      </div>
    </nz-card>
  </div>
}


